{% extends 'base.html' %}
{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<style>
  .watchlist{max-width:1400px;margin:0 auto}
  .watchlist h2{margin:0 0 1rem}
  .student-table{width:100%;border-collapse:collapse;background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden}
  .student-table th,.student-table td{padding:1rem;text-align:left;border-bottom:1px solid var(--border)}
  .student-table th{background:var(--panel);font-weight:600}
  .student-table tr:hover{background:var(--panel)}
  .stress-badge{display:inline-block;padding:.4rem .7rem;border-radius:8px;font-weight:600;font-size:.9rem}
  .stress-low{background:#10b981;color:#fff}
  .stress-mid{background:#f59e0b;color:#fff}
  .stress-high{background:#ef4444;color:#fff}
  .sparkline-cell{width:150px}
  .sparkline-cell canvas{width:100%;height:40px}
  .action-btn{padding:.5rem .8rem;border-radius:8px;border:1px solid var(--border);background:var(--accent);color:var(--btn-text);cursor:pointer;font-size:.9rem}
</style>

<div class="watchlist">
  <div class="card" style="margin-bottom:1rem">
    <h2>Student Watchlist</h2>
    <p class="pill">Monitor students' wellness and stress trends over the last 7 days.</p>
  </div>
  
  <table class="student-table" id="studentTable">
    <thead>
      <tr>
        <th>Student</th>
        <th>Latest Mood</th>
        <th>Avg Stress</th>
        <th class="sparkline-cell">7-Day Trend</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="studentBody">
      <tr><td colspan="5" style="text-align:center;color:var(--muted)">Loading...</td></tr>
    </tbody>
  </table>
</div>

<script>
const moodEmoji = {happy:'üòä',calm:'üòå',normal:'üòê',sad:'üò¢',anxious:'üòü',stressed:'üò∞',angry:'üò°'};
async function loadStudents(){
  try{
    const r = await fetch('/api/proctor/students');
    const j = await r.json();
    if(!j.students) return;
    const tbody = document.getElementById('studentBody');
    tbody.innerHTML='';
    j.students.forEach((s,i)=>{
      const tr=document.createElement('tr');
      const stress= s.avg_stress;
      const badge= stress<=40?'stress-low':stress<=75?'stress-mid':'stress-high';
      tr.innerHTML=`
        <td>${s.name}</td>
        <td style="font-size:1.3rem">${moodEmoji[s.mood]||'üòê'}</td>
        <td><span class="stress-badge ${badge}">${stress}</span></td>
        <td class="sparkline-cell"><canvas id="spark${i}"></canvas></td>
        <td><a class="action-btn" href="/proctor/student/${encodeURIComponent(s.email)}">View</a></td>
      `;
      tbody.appendChild(tr);
      const ctx=document.getElementById('spark'+i).getContext('2d');
      new Chart(ctx,{
        type:'line',
        data:{labels:s.trend.map((_,idx)=>''),datasets:[{data:s.trend,borderColor:'#6366f1',borderWidth:2,tension:0.3,pointRadius:0}]},
        options:{plugins:{legend:{display:false}},scales:{x:{display:false},y:{display:false,min:0,max:100}},maintainAspectRatio:false}
      });
    });
  }catch(e){console.error(e);}
}
window.addEventListener('DOMContentLoaded',loadStudents);
</script>
{% endblock %}
